<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kraken – CPU / GPU / Liquid (style premium)</title>
  <style>
    :root{
      --bg:#0b0b0c; --fg:#e7e7ea; --muted:#9aa0a6; --hot:#ff5b5b;
      --cpu:#ff9157; --gpu:#55b0ff; --liq:#55e0e0;
      --ring:#1b1c22; --glass:rgba(255,255,255,.06);
    }
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial;display:grid;place-items:center;overflow:hidden}
    #app{display:none;width:100vmin;height:100vmin;max-width:100vw;max-height:100vh;aspect-ratio:1/1;border-radius:50%;position:relative;}
    #app.active{display:block}
    #dial{width:100%;height:100%;display:block}

    /* Panneau central 3 colonnes façon MSI mais en cercle */
    .panel{position:absolute;inset:14% 10%;display:grid;grid-template-columns:1fr .6px 1fr .6px 1fr;align-items:center}
    .cut{background:linear-gradient(180deg,transparent 0,rgba(255,255,255,.06) 12%,rgba(255,255,255,.06) 88%,transparent 100%);width:.6px;height:68%;justify-self:center}
    .col{display:grid;justify-items:center;gap:.35em}
    .name{display:flex;align-items:center;gap:.4em;color:var(--muted);font-weight:600;font-size:clamp(10px,2.6vmin,16px)}
    .big{font-weight:900;font-size:clamp(22px,8vmin,60px);line-height:1}
    .unit{font-size:.55em;opacity:.9;font-weight:800;margin-left:.1em}
    .sub{font-size:clamp(10px,2.5vmin,14px);opacity:.95}

    /* chips arrondis derrière les icônes */
    .chip{width:1.7em;height:1.7em;border-radius:50%;display:grid;place-items:center;background:var(--glass);backdrop-filter:blur(3px)}
    .ic{width:1em;height:1em;opacity:.9}

    /* Debug */
    #dbg{position:fixed;left:8px;bottom:8px;font:12px/1.3 system-ui;background:rgba(0,0,0,.55);color:#fff;padding:6px 8px;border-radius:8px;display:none;white-space:pre;z-index:9}
    #dbg.on{display:block}
  </style>
</head>
<body>
  <div id="app">
    <div id="dbg"></div>
    <canvas id="dial"></canvas>

    <div class="panel">
      <div class="col">
        <div class="name" id="namecpu"><span class="chip"><svg class="ic" viewBox="0 0 24 24" fill="currentColor"><path d="M8 2h2v2h4V2h2v2h2a2 2 0 0 1 2 2v2h2v2h-2v4h2v2h-2v2a2 2 0 0 1-2 2h-2v2h-2v-2h-4v2H8v-2H6a2 2 0 0 1-2-2v-2H2v-2h2V8H2V6h2V4a2 2 0 0 1 2-2h2Zm-2 6v8h12V8H6Z"/></svg></span><span>CPU</span></div>
        <div class="big" id="cpu">--<span class="unit">°C</span></div>
        <div class="sub" id="loadcpu">--%</div>
      </div>
      <div class="cut"></div>
      <div class="col">
        <div class="name" id="namegpu"><span class="chip"><svg class="ic" viewBox="0 0 24 24" fill="currentColor"><path d="M3 7h14a2 2 0 0 1 2 2v6h2v2h-2v2h-2v-2H5a2 2 0 0 1-2-2V7Zm2 2v6h12V9H5Zm3 1h2v2H8v-2Zm4 0h2v2h-2v-2Z"/></svg></span><span>GPU</span></div>
        <div class="big" id="gpu">--<span class="unit">°C</span></div>
        <div class="sub" id="loadgpu">--%</div>
      </div>
      <div class="cut"></div>
      <div class="col">
        <div class="name" id="nameliq"><span class="chip"><svg class="ic" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2s6 7.2 6 11.2S15.3 20 12 20s-6-2.3-6-6.8S12 2 12 2Z"/></svg></span><span>LIQUID</span></div>
        <div class="big" id="liq">--<span class="unit">°C</span></div>
        <div class="sub" id="flowliq">&nbsp;</div>
      </div>
    </div>
  </div>

  <script>
  (function(){
    const $ = (id) => document.getElementById(id);
    const fmt = (n) => (n==null || Number.isNaN(n)) ? "--" : Math.round(n).toString();
    const getVar = (name) => getComputedStyle(document.documentElement).getPropertyValue(name).trim();

    const app = $("app"), canvas = $("dial"), ctx = canvas.getContext('2d');
    const hist = { cpu: [], gpu: [], liq: [] };
    const params = new URLSearchParams(location.search);
    const isDemo = params.get('demo') === '1';
    const isDebug = params.get('debug') === '1';
    const dbg = $('dbg');

    function logDbg(msg){ if (!isDebug) return; dbg.classList.add('on'); dbg.textContent = String(msg); }

    function resize(){
      const rect = canvas.getBoundingClientRect();
      const dpr = Math.max(1, Math.floor(window.devicePixelRatio||1));
      canvas.width = Math.round(rect.width*dpr);
      canvas.height = Math.round(rect.height*dpr);
      ctx.setTransform(dpr,0,0,dpr,0,0);
      draw();
    }
    window.addEventListener('resize', resize);
    resize();

    function push(arr, v){ if (typeof v==='number' && !Number.isNaN(v)) arr.push(v); if (arr.length>90) arr.shift(); }

    function draw(){
      const w = canvas.clientWidth, h = canvas.clientHeight; if (!w||!h) return;
      const cx = w/2, cy = h/2; const R = Math.min(w,h)/2 - 10;
      ctx.clearRect(0,0,w,h);

      // anneau de fond
      ctx.save(); ctx.translate(cx,cy);
      ctx.beginPath(); ctx.lineWidth = Math.max(10, R*0.14); ctx.lineCap='round';
      ctx.strokeStyle = getVar('--ring');
      ctx.arc(0,0,R*0.82, 0, Math.PI*2); ctx.stroke();

      // segments (CPU/GPU/LIQ) – couleurs premium + hot en rouge
      const segGap = Math.PI * 0.09; // plus d'espace, style MSI
      const segLen = (Math.PI*2 - segGap*3)/3;
      const baseA = -Math.PI/2;
      const last = { cpu: hist.cpu.at(-1), gpu: hist.gpu.at(-1), liq: hist.liq.at(-1) };
      const parts = [
        {key:'cpu', a0:baseA,                    col:getVar('--cpu'), hot:last.cpu>80},
        {key:'gpu', a0:baseA+segLen+segGap,      col:getVar('--gpu'), hot:last.gpu>75},
        {key:'liq', a0:baseA+(segLen+segGap)*2,  col:getVar('--liq'), hot:last.liq>37},
      ];
      parts.forEach(p=>{
        const a1 = p.a0 + segLen;
        ctx.beginPath(); ctx.lineWidth = Math.max(10, R*0.14); ctx.lineCap='round';
        ctx.strokeStyle = p.hot? getVar('--hot') : p.col;
        ctx.arc(0,0,R*0.82, p.a0, a1); ctx.stroke();
      });
      ctx.restore();
    }

    function paintValues(cpu, gpu, liq, cpuLoad, gpuLoad){
      $('cpu').firstChild.nodeValue = fmt(cpu);
      $('gpu').firstChild.nodeValue = fmt(gpu);
      $('liq').firstChild.nodeValue = fmt(liq);
      $('loadcpu').textContent = (typeof cpuLoad==='number')? (Math.round(cpuLoad)+"%") : "--%";
      $('loadgpu').textContent = (typeof gpuLoad==='number')? (Math.round(gpuLoad)+"%") : "--%";
      // coloriser noms selon capteurs
      $('namecpu').style.color = getVar('--cpu');
      $('namegpu').style.color = getVar('--gpu');
      $('nameliq').style.color = getVar('--liq');
      draw();
    }

    let armed=false;
    function handleMonitoringData(data){
      try{
        const cpuOffset = parseInt(params.get('cpudelta')||'-5',10);
        const cpuRaw = Array.isArray(data?.cpus) ? data.cpus[0]?.temperature : data?.cpu?.temperature;
        const cpu = (typeof cpuRaw==='number') ? cpuRaw + cpuOffset : cpuRaw;
        const gpu = Array.isArray(data?.gpus) ? data.gpus[0]?.temperature : data?.gpu?.temperature;
        const liq = data?.kraken?.liquidTemperature ?? data?.kraken?.liquidTemp ?? data?.cooler?.liquidTemp;
        const cpuLoad = data?.cpu?.load ?? data?.cpu?.utilization ?? data?.cpus?.[0]?.load;
        const gpuLoad = data?.gpus?.[0]?.load ?? data?.gpu?.load ?? data?.gpus?.[0]?.utilization;
        if ([cpu,gpu,liq].every(v=>typeof v==='number' && !Number.isNaN(v))){
          if (!armed){ armed=true; app.classList.add('active'); }
          push(hist.cpu,cpu); push(hist.gpu,gpu); push(hist.liq,liq);
          paintValues(cpu,gpu,liq,cpuLoad,gpuLoad);
          logDbg(`OK CPU:${cpu} GPU:${gpu} LIQ:${liq}`);
        } else {
          logDbg(`Invalid cpu:${cpu} gpu:${gpu} liq:${liq}`);
        }
      }catch(e){ logDbg('Erreur données'); }
    }

    // Hook CAM
    window.nzxt = window.nzxt || {}; window.nzxt.v1 = window.nzxt.v1 || {};
    window.nzxt.v1.onMonitoringDataUpdate = handleMonitoringData;
    if (typeof window.nzxt.v1.subscribeMonitoringData === 'function'){
      try{ window.nzxt.v1.subscribeMonitoringData(handleMonitoringData); }catch(_){}}

    // Démo
    if (isDemo){
      app.classList.add('active');
      let t=0,cpu=37,gpu=40,liq=31; let cpuLoad=18,gpuLoad=12;
      setInterval(()=>{
        t++; cpu = 35+10*Math.sin(t/6); gpu=38+14*Math.sin(t/7+1.2); liq=30+3*Math.sin(t/10);
        cpuLoad = 18+12*Math.abs(Math.sin(t/8)); gpuLoad = 12+16*Math.abs(Math.sin(t/10));
        push(hist.cpu,cpu); push(hist.gpu,gpu); push(hist.liq,liq);
        paintValues(cpu,gpu,liq,cpuLoad,gpuLoad);
      },1000);
    }
  })();
  </script>
</body>
</html>
