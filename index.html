<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kraken Dial – CPU / GPU / Liquid (style anneau)</title>
  <style>
    :root {
      --bg: #0b0b0c;
      --fg: #e7e7ea;
      --muted: #9aa0a6;
      --hot: #ff6b6b;
      --cpu: #ff7b54;
      --gpu: #6aa0ff;
      --liq: #55e0e0;
    }
    html, body { height: 100%; }
    body {
      margin: 0; background: var(--bg); color: var(--fg);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial;
      display: grid; place-items: center;
      overflow: hidden;
    }
    #app { display:none; width: 100vmin; height: 100vmin; max-width:100vw; max-height:100vh; aspect-ratio:1/1; border-radius:50%; overflow:hidden; position:relative; }
    #app.active { display:block; }
    #dial { width:100%; height:100%; display:block; }

    .panel { position:absolute; inset:15% 10%; display:grid; grid-template-columns: 1fr 1fr 1fr; align-items:center; }
    .col { display:grid; justify-items:center; gap:.35em; }
    .sep { width:1px; height:70%; background: rgba(255,255,255,.08); justify-self:center; }
    .name { font-size: clamp(10px, 2.8vmin, 16px); color: var(--muted); font-weight:600; }
    .big { font-weight:900; font-size: clamp(22px, 7.8vmin, 56px); }
    .unit { font-size:.55em; opacity:.85; font-weight:700; }
    .small { font-size: clamp(10px, 2.6vmin, 14px); opacity:.9; }

    #dbg{position:fixed;left:8px;bottom:8px;font:12px/1.3 system-ui;background:rgba(0,0,0,.55);color:#fff;padding:6px 8px;border-radius:8px;display:none;white-space:pre;z-index:9}
    #dbg.on{display:block}
  </style>
</head>
<body>
  <div id="app">
    <div id="dbg"></div>
    <canvas id="dial"></canvas>
    <div class="panel">
      <div class="col">
        <div class="name" id="namecpu">CPU</div>
        <div><span class="big val" id="cpu">--<span class="unit">°C</span></span></div>
        <div class="small" id="loadcpu">--%</div>
      </div>
      <div class="sep"></div>
      <div class="col">
        <div class="name" id="namegpu">GPU</div>
        <div><span class="big val" id="gpu">--<span class="unit">°C</span></span></div>
        <div class="small" id="loadgpu">--%</div>
      </div>
      <div class="sep"></div>
      <div class="col">
        <div class="name" id="nameliq">LIQUID</div>
        <div><span class="big val" id="liq">--<span class="unit">°C</span></span></div>
        <div class="small" id="flowliq">&nbsp;</div>
      </div>
    </div>
  </div>

  <script>
  (function(){
    const $ = (id) => document.getElementById(id);
    const fmt = (n) => (n==null || Number.isNaN(n)) ? "--" : Math.round(n).toString();
    const getVar = (name) => getComputedStyle(document.documentElement).getPropertyValue(name).trim();

    const app = $("app"), canvas = $("dial"), ctx = canvas.getContext('2d');
    const hist = { cpu: [], gpu: [], liq: [] };
    const params = new URLSearchParams(location.search);
    const isDemo = params.get('demo') === '1';
    const isDebug = params.get('debug') === '1';
    const dbg = document.getElementById('dbg');

    function resize(){
      const rect = canvas.getBoundingClientRect();
      canvas.width = rect.width;
      canvas.height = rect.height;
      draw();
    }
    window.addEventListener('resize', resize);
    resize(); // initialise dès le départ

    function push(arr, v){
      if (typeof v === 'number' && !Number.isNaN(v)) arr.push(v);
      if (arr.length > 60) arr.shift();
    }

    function draw(){
      const w = canvas.clientWidth, h = canvas.clientHeight; if (!w||!h) return;
      const cx = w/2, cy = h/2; const R = Math.min(w,h)/2 - 10;
      ctx.clearRect(0,0,w,h);

      ctx.save();
      ctx.translate(cx, cy);
      ctx.beginPath();
      ctx.lineWidth = R*0.14;
      ctx.strokeStyle = 'rgba(255,255,255,0.08)';
      ctx.arc(0,0,R*0.82, 0, Math.PI*2);
      ctx.stroke();

      const segGap = Math.PI * 0.06;
      const segLen = (Math.PI*2 - segGap*3)/3;
      const baseA = -Math.PI/2;
      const last = {
        cpu: hist.cpu[hist.cpu.length-1],
        gpu: hist.gpu[hist.gpu.length-1],
        liq: hist.liq[hist.liq.length-1],
      };
      const parts = [
        {key:'cpu',  a0: baseA,                   col: getVar('--cpu'),  hot: (last.cpu>80)},
        {key:'gpu',  a0: baseA + segLen + segGap, col: getVar('--gpu'),  hot: (last.gpu>75)},
        {key:'liq',  a0: baseA + (segLen+segGap)*2, col: getVar('--liq'), hot: (last.liq>37)},
      ];
      parts.forEach(p=>{
        const a1 = p.a0 + segLen;
        ctx.beginPath();
        ctx.lineWidth = R*0.14;
        ctx.lineCap = 'round';
        ctx.strokeStyle = p.hot ? getVar('--hot') : p.col;
        ctx.arc(0,0,R*0.82, p.a0, a1);
        ctx.stroke();
      });
      ctx.restore();
    }

    function paintValues(cpu, gpu, liq){
      $('cpu').firstChild.nodeValue = fmt(cpu);
      $('gpu').firstChild.nodeValue = fmt(gpu);
      $('liq').firstChild.nodeValue = fmt(liq);
      draw();
    }

    function logDbg(msg){ if (!isDebug) return; dbg.classList.add('on'); dbg.textContent = String(msg); }

    let armed = false;
    function handleMonitoringData(data){
      try {
        const cpuOffset = parseInt(params.get('cpudelta')||'-5',10);
        const cpuRaw = Array.isArray(data?.cpus) ? data.cpus[0]?.temperature : data?.cpu?.temperature;
        const cpu = (typeof cpuRaw==='number') ? cpuRaw + cpuOffset : cpuRaw;
        const gpu = Array.isArray(data?.gpus) ? data.gpus[0]?.temperature : data?.gpu?.temperature;
        const liq = data?.kraken?.liquidTemperature ?? data?.kraken?.liquidTemp ?? data?.cooler?.liquidTemp;
        if ([cpu,gpu,liq].every(v => typeof v === 'number' && !Number.isNaN(v))){
          if (!armed){ armed = true; app.classList.add('active'); resize(); }
          push(hist.cpu, cpu); push(hist.gpu, gpu); push(hist.liq, liq);
          paintValues(cpu,gpu,liq);
          logDbg(`OK CPU:${cpu} GPU:${gpu} LIQ:${liq}`);
        } else {
          logDbg(`Invalid cpu:${cpu} gpu:${gpu} liq:${liq}`);
        }
      } catch(e){ logDbg('Erreur données'); }
    }

    window.nzxt = window.nzxt || {};
    window.nzxt.v1 = window.nzxt.v1 || {};
    window.nzxt.v1.onMonitoringDataUpdate = handleMonitoringData;
    if (typeof window.nzxt.v1.subscribeMonitoringData === 'function'){
      try { window.nzxt.v1.subscribeMonitoringData(handleMonitoringData); } catch(_){}}

    if (isDemo){
      app.classList.add('active'); resize();
      let t=0,cpu=37,gpu=40,liq=31;
      setInterval(()=>{
        t++; cpu = 35+10*Math.sin(t/6); gpu=38+14*Math.sin(t/7+1.2); liq=30+3*Math.sin(t/10);
        push(hist.cpu,cpu); push(hist.gpu,gpu); push(hist.liq,liq);
        paintValues(cpu,gpu,liq);
      },1000);
    }
  })();
  </script>
</body>
</html>
